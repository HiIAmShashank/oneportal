#!/usr/bin/env node
/**
 * Simple Environment File Writer for CI/CD and Local Testing
 * 
 * Usage:
 *   node scripts/write-env-files.js [--target=production|production.local]
 * 
 * Modes:
 *   - CI/CD: Auto-detected, creates .env.production from GitHub Secrets
 *   - Local: Creates .env.production.local from .secrets.local for SWA CLI testing
 */

import fs from 'fs-extra';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const ROOT_DIR = path.resolve(__dirname, '..');
const APPS_DIR = path.join(ROOT_DIR, 'apps');

// Parse command line arguments
const args = process.argv.slice(2);
const targetArg = args.find(arg => arg.startsWith('--target='));
const isCI = process.env.CI === 'true' || process.env.GITHUB_ACTIONS === 'true';

// Determine target: production (CI/CD) or production.local (local testing)
const target = targetArg
    ? targetArg.split('=')[1]
    : (isCI ? 'production' : 'production.local');

// Determine source file for local mode
const sourceFile = target === 'production.local' ? '.secrets.local' : null;

// Required variables that must be present for each app
const REQUIRED_AUTH_VARS = ['AUTH_CLIENT_ID', 'AUTH_AUTHORITY', 'AUTH_REDIRECT_URI', 'AUTH_SCOPES', 'APP_NAME'];

function checkRequired(varName) {
    const value = process.env[varName];
    if (!value) {
        console.error(`Error: Missing required environment variable: ${varName}`);
        return false;
    }
    return true;
}

function getEnvVar(varName) {
    return process.env[varName] || null;
}

function loadEnvFile(filePath) {
    if (!filePath || !fs.existsSync(filePath)) return false;
    const content = fs.readFileSync(filePath, 'utf8');
    content.split('\n').forEach((line) => {
        const trimmed = line.trim();
        if (!trimmed || trimmed.startsWith('#')) return;
        const delimiterIndex = trimmed.indexOf('=');
        if (delimiterIndex === -1) return;
        const key = trimmed.slice(0, delimiterIndex).trim();
        const value = trimmed.slice(delimiterIndex + 1).trim();
        if (!process.env[key]) process.env[key] = value;
    });
    return true;
}

function discoverApps() {
    const apps = [];
    const entries = fs.readdirSync(APPS_DIR, { withFileTypes: true });

    for (const entry of entries) {
        if (!entry.isDirectory()) continue;

        const appDir = entry.name;
        const packageJsonPath = path.join(APPS_DIR, appDir, 'package.json');

        if (!fs.existsSync(packageJsonPath)) continue;

        const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));

        // Skip storybook
        if (packageJson.name === '@one-portal/storybook') continue;

        const prefix = packageJson.name?.replace(/^@[^/]+\//, '').replace(/^remote-/, '').replace(/-/g, '_').toUpperCase();

        if (prefix) {
            apps.push({ name: packageJson.name || appDir, dir: appDir, prefix });
        }
    }

    return apps;
}

function getAllViteVarsForPrefix(prefix) {
    const vars = {};
    const prefixPattern = `VITE_${prefix}_`;

    for (const [key, value] of Object.entries(process.env)) {
        if (key.startsWith(prefixPattern)) {
            vars[key] = value;
        }
    }

    return vars;
}

async function writeEnvFile(appConfig) {
    const { name, dir, prefix } = appConfig;
    const envFilePath = path.join(APPS_DIR, dir, `.env.${target}`);

    console.log(`\nWriting ${name} environment file (.env.${target})...`);

    // Check required variables
    let hasAllRequired = true;
    const requiredVars = REQUIRED_AUTH_VARS.map(v => `VITE_${prefix}_${v}`);

    for (const varName of requiredVars) {
        if (!checkRequired(varName)) hasAllRequired = false;
    }

    if (!hasAllRequired) {
        console.error(`Warning: Skipping ${name} - missing required variables\n`);
        return false;
    }

    // Discover all VITE_{PREFIX}_* variables
    const allVars = getAllViteVarsForPrefix(prefix);

    if (Object.keys(allVars).length === 0) {
        console.error(`Warning: Skipping ${name} - no VITE_${prefix}_* variables found\n`);
        return false;
    }

    const header = target === 'production'
        ? '# DO NOT EDIT MANUALLY - This file is created during CI/CD builds'
        : '# DO NOT EDIT MANUALLY - This file is created for local testing';

    const lines = ['# Auto-generated by scripts/write-env-files.js', header, ''];

    // Write all discovered variables (sorted for consistency)
    const sortedVars = Object.entries(allVars).sort(([a], [b]) => a.localeCompare(b));
    for (const [varName, value] of sortedVars) {
        lines.push(`${varName}=${value}`);
    }

    // Add VITE_APP_MODE if present
    const appMode = getEnvVar('VITE_APP_MODE');
    if (appMode) lines.push(`VITE_APP_MODE=${appMode}`);

    const content = lines.join('\n') + '\n';
    await fs.writeFile(envFilePath, content, 'utf8');

    console.log(`Created: ${path.relative(ROOT_DIR, envFilePath)} (${Object.keys(allVars).length} variables)`);
    return true;
}

async function main() {
    console.log('Starting environment file generation...\n');
    console.log(`   Target: .env.${target}`);
    console.log(`   Mode: ${isCI ? 'CI/CD' : 'Local'}\n`);

    if (sourceFile) {
        const sourceFilePath = path.join(ROOT_DIR, sourceFile);
        console.log(`Loading variables from: ${sourceFile}`);

        if (!loadEnvFile(sourceFilePath)) {
            console.error(`Error: Source file not found: ${sourceFile}`);
            console.error(`   Create it from .secrets.local.example\n`);
            process.exit(1);
        }

        console.log(`Loaded variables from ${sourceFile}\n`);
    } else {
        console.log(`Using environment variables from process.env (GitHub Secrets)\n`);
    }

    if (!await fs.pathExists(APPS_DIR)) {
        console.error(`Error: Apps directory not found at ${APPS_DIR}`);
        process.exit(1);
    }

    // Auto-discover apps from apps/ directory
    const apps = discoverApps();

    if (apps.length === 0) {
        console.error(`Error: No apps found in ${APPS_DIR}`);
        process.exit(1);
    }

    console.log(`Discovered ${apps.length} app(s): ${apps.map(a => a.name).join(', ')}\n`);

    let successCount = 0;
    let failCount = 0;

    for (const appConfig of apps) {
        const success = await writeEnvFile(appConfig);
        if (success) successCount++;
        else failCount++;
    }

    console.log('\n' + '='.repeat(60));
    console.log('Summary:');
    console.log(`   Success: ${successCount} file(s)`);
    if (failCount > 0) console.log(`   Failed: ${failCount} file(s)`);
    console.log('='.repeat(60) + '\n');

    if (successCount === 0) {
        console.error('Error: No environment files were generated');
        console.error('   Ensure all required VITE_ prefixed variables are set.');
        process.exit(1);
    }

    console.log('Environment file generation complete!\n');
}

main().catch(error => {
    console.error(`\nFatal error: ${error.message}`);
    console.error(error);
    process.exit(1);
});
